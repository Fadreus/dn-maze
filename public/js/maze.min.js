function init_description(e){$(e).popover({animation:!1,html:!0,trigger:"manual",placement:"auto left",container:$body}).on("mouseenter",$dpop.mouseenter).on("mouseleave",$dpop.mouseleave).on("mousedown",$dpop.mousedown)}function update_description(e,t){var a=e.getAttribute("data-skill"),l=Job.Cache[a],s=db.Skills[a],n=t.data("bs.popover").options;n.title=tag("span",Job.ApplyType?"s":null,format($lang.name[Job.ApplyType],db.Lookup[s.NameID]));var i=n.content?n.content:desc_fields.clone(!0);i.find(".dlvl").find("span:last").text(Math.max(1,l[0]+l[3])+(l[3]>0?" (+"+l[3]+")":"")),i.find(".dlimit").find("span:last").text(l[4]),l[2]?i.find(".dtsp").show().removeClass("hidden").find("span:last").text(l[2]):i.find(".dtsp").hide().addClass("hidden"),s.NeedWeaponType?i.find(".dweaps").find("span:last").text(s.NeedWeaponType.map($d.weapon).join(", ")):i.find(".dweaps").remove();var r=$lang.type.passive;switch(s.SkillType){case 0:switch(s.DurationType){case 0:r=$lang.type.instant;break;case 1:r=$lang.type.buff;break;case 2:r=$lang.type.debuff}break;case 3:r=$lang.type.ex}i.find(".dtype").find("span:last").text(r);var o=$lang.element.none;switch(s.Element){case 0:o=$lang.element.fire;break;case 1:o=$lang.element.water;break;case 2:o=$lang.element.light;break;case 3:o=$lang.element.dark}i.find(".dele").find("span:last").text(o);var d,p,u,c,f=l[0]+l[3];if(d=s.Levels[f],u=d?d.ApplyType[Job.ApplyType]:null,p=s.Levels[f+1],c=p?p.ApplyType[Job.ApplyType]:null,0==f&&(d=p,u=c),p){if(i.find(".dreq").show().removeClass("hidden"),i.find(".dreqlvl").find("span:last").removeClass("r").addClass(Job.MaxLevel<p.LevelLimit?"r":null).text(p.LevelLimit),s.NeedSP?i.find(".dreqtsp").empty().append(s.NeedSP.map($d.sp)):i.find(".dreqtsp").remove(),s.ParentSkills){var v=[];for(var g in s.ParentSkills){var b=s.ParentSkills[g],h=Job.Cache[g];v.push(tag("div",h[0]<b?"r":null,format($lang.req.parent,db.Lookup[db.Skills[g].NameID],b)))}i.find(".dreqskills").empty().append(v)}else i.find(".dreqskills").remove();var m=t.closest(".panel").data("job"),k=get_max_sp(),$=Job.TSP[m],_=get_total_sp();i.find(".dreqsp").find("span:last").text(p.SkillPoint).removeClass("r").addClass($+p.SkillPoint>k*Job.SP[m]||_+p.SkillPoint>k?"r":null)}else i.find(".dreq").hide().addClass("hidden");var S=u?u.DecreaseSP:c.DecreaseSP;S?i.find(".dmp").removeClass("hidden").show().find("span:last").text(S):i.find(".dmp").hide().addClass("hidden");var x=(u?u.DelayTime:c.DelayTime)/1e3;x?i.find(".dcd").removeClass("hidden").show().find("span:last").text(format($lang.cd,x)):i.find(".dcd").hide().addClass("hidden");var y=u?u.SkillExplanationID:c.SkillExplanationID,J=u?u.SkillExplanationIDParam:c.SkillExplanationIDParam;i.find(".dnowv").html(desc_format(db.Lookup[y],J)),0==f||f==s.MaxLevel?(i.find(".dnext").hide().addClass("hidden"),i.find(".dnextdiv").hide()):(i.find(".dnextdiv").show(),i.find(".dnext").show().removeClass("hidden"),i.find(".dnextv").html(desc_format(db.Lookup[c.SkillExplanationID],c.SkillExplanationIDParam))),n.content=i}function desc_tag(e,t){return tag("div",e).append(tag("span","o",t+": "),tag("span"))}function desc_format(e,t){t=t.split(",").map($d.params);for(var a=0;a<t.length;a++)e=e.replace("{"+a+"}",t[a]);for(var l=0,s=0,n="",i=0,a=0;a<e.length-1;a++)switch(e.substr(a,2)){case"#y":case"#p":case"#r":case"#s":case"#v":l-s==1?n+=e.substring(i,a)+'</span><span class="'+e.substr(a+1,1)+'">':(n+=e.substring(i,a)+'<span class="'+e.substr(a+1,1)+'">',l++),i=a+2,++a;break;case"#w":s==l?n+=e.substring(i,a):(n+=e.substring(i,a)+"</span>",s++),i=a+2,++a}return n+=e.substr(i),l!=s&&(n+="</span>"),n.replace(/\\n/g,"<br />")}function dnss(e){$(".jobsprite").each(function(){this.style.backgroundImage="url('"+e.mainbar+"/"+$TIMESTAMP+"-jobicon_pvp.png')"}),$.getJSON(e.job,function(e){db=e,dskills.each(function(){this.setAttribute("data-desc","hover"),init_description(this)})}),dskills.each(function(){var t=$(this),a=this.getAttribute("data-skill"),l=Job.Cache[a],s=0==l[0]?"_b":"",n=Job.Sprites[a];n[1]*=-50,n[2]*=-50,this.style.background="url('"+e.mainbar+"/"+$TIMESTAMP+"-skillicon"+n[0]+s+".png') "+n[1]+"px "+n[2]+"px",this.getElementsByClassName("skill-bdr")[0].style.background="url('"+e.border+"') 100px 0",t.find(".skill-lvl").text([l[0]+l[3],l[4]].join("/")),t.on("mousedown",skill_adj)}),$(".panel-body").on("contextmenu",prevent_default);for(var t=Job.Levels.length;t>0;t--)$("#level").append(tag("option",null,format(lang.level.option,t)).val(t));$("#level").val(Job.MaxLevel),$("#pvp").click(reverse("#pve",function(){return set_cookie("apply_type",1),Job.ApplyType=1,$dpop.persist&&$dpop.update($dpop.persist[0],$dpop.persist),!0})),$("#pve").click(reverse("#pvp",function(){return set_cookie("apply_type",0),Job.ApplyType=0,$dpop.persist&&$dpop.update($dpop.persist[0],$dpop.persist),!0})),$("#free").click(reverse("#strict",function(){return set_cookie("free",1),Job.Free=!0})),$("#strict").click(reverse("#free",strict_switch));var a=0;$("#s").val("").on("input",function(){++a;var e=a,t=$("#s").val();setTimeout(function(){if(a==e){a=0;var l;try{l=new RegExp(t,"im")}catch(s){return}dskills.each(function(){var e=$(this);if(t.length>2){update_description(this,e);var a=e.data("bs.popover").options,s=a.title.text();if(l.test(s))return void(this.style.opacity=1);s=a.content.clone(),s.find(".hidden").remove(),this.style.opacity=l.test(s.text())?1:.33}else this.style.opacity=1})}},500)}),$("#level").change(function(){var e=num($(this).val());$("#level-btn").text(e<=Job.MaxLevel?lang.level.reset:lang.level.raise)}),$("#level-btn").mousedown(function(){var e=num($("#level").val());dskills.each(function(){var t=$(this),a=this.getAttribute("data-skill"),l=db.Skills[a],s=Job.Cache[a];if(e<=Job.MaxLevel){s[0]=1==db.Skills[a].Levels[1].LevelLimit?1:0,s[2]=0,s[3]=0;var n=this.style.backgroundImage.replace("_b.png",".png");this.style.backgroundImage=s[0]?n:n.replace(".png","_b.png"),t.find(".skill-bdr").removeClass("g").addClass(s[0]?null:"g")}if(e!=Job.MaxLevel){for(var i=0,r=l.MaxLevel-l.SPMaxLevel,o=r,d=1;o>0;o--,d++){if(l.Levels[o].LevelLimit<=e){i=o;break}if(!(l.Levels[d].LevelLimit<=e))break;i=d}s[1]=Math.min(i,r)}t.find(".skill-lvl").removeClass(e<=Job.MaxLevel?"g b":null).text([s[0]+s[3],s[4]].join("/")),t.data("lvl",s.join(","))});var t=get_max_sp(e);$(".panel").each(function(a){var l=$(this).find(".panel-heading").find("span"),s=l.text().split("/").map(num),n=Job.SP[a];s[1]=num(t*n),e<=Job.MaxLevel&&(s[0]=0),l.text(s.join("/"))}),e<=Job.MaxLevel&&(Job.TSP=[0,0,0],Job.SkillGroups={},Job.BaseSkills={}),Job.MaxLevel=e,update_progress(),$(this).text(lang.level.reset),history_push()}),$("#techs").click(techniques)}function update_progress(){var e=get_total_sp(),t=get_max_sp(),a=e/t*100;$("#max-progress").text(format(lang.progress.max,t)),$("#progress").css("width",a+"%"),$("#rem-progress").text(format(lang.progress.remaining,t-e)),$("#curr-progress").text(format(lang.progress.curr,e))}function set_opacity(e,t){return 0>t||t>1?-1:(e.css("opacity",t),t)}function prevent_default(e){e.preventDefault()}function num(e){return parseInt(e)}function sum(e,t){return e+t}function get_total_sp(){return Job.TSP.reduce(sum)}function get_max_sp(e){return Job.Levels.slice(0,e||Job.MaxLevel).reduce(sum)}function tag(e,t,a){return $(document.createElement(e)).addClass(t).text(a)}function reverse(e,t){return function(){t()!==!1&&($(e).removeClass(ON).addClass(OFF),$(this).addClass(ON),history_push())}}function strict_checker(e){var t=($("#modal"),$("#modal-title")),a=$("#modal-body"),l=!0,s=[];return dskills.each(function(){var e=num(this.getAttribute("data-skill")),t=Job.Cache[e],a=db.Skills[e];if(t[0]>0){if(!check_skill_reqs_state(e,a,s))return void(l=!1);if(!check_skill_groups(e,a,s))return void(l=!1)}}),l&&e?(Job.Free=!1,set_cookie("free",0)):(t.text(lang.strict_title),a.empty().append(s.map(function(e){return tag("p",null,e)}))),l}function strict_switch(){return strict_checker(!0)?!0:($("#modal").modal("show"),!1)}function history_push(){var e=[];dskills.each(function(){var t=this.getAttribute("data-skill"),a=Job.Sprites[t][3],l=Job.Cache[t],s=1==db.Skills[t].Levels[1].LevelLimit?1:0,n=[];n.push(build_chars[l[0]-s]),l[3]>0&&n.push("!"),l[3]>1&&n.push("!"),e[a]=n});for(var t=[],a=0;72>a;a++)void 0===e[a]?t.push("-"):t=t.concat(e[a]);history.pushState(Job,null,"/"+Job.EnglishName+"-"+Job.MaxLevel+"/"+t.join(""))}function set_cookie(e,t){var a=new Date;a.setTime(a.getTime()+307584e5),document.cookie=e+"="+t+"; path=/; expires="+a.toUTCString()}function format(e){for(var t=Array.prototype.slice.call(arguments,1),a="",l=e.length,s=0,n=0;l>n;n++){var i=e[n],r=e[n+1];"?"==i?"?"==r?(++n,a+="?"):(a+=void 0===t[s]?"":t[s],s++):a+=i}return a}function skill_adj(e){if(!e.altKey){var t=$(this),a=num(this.getAttribute("data-skill")),l=e.shiftKey||e.ctrlKey,s=[].concat(Job.Cache[a]),n=this.style.backgroundImage.replace("_b.png",".png"),i=db.Skills[a],r=s[0];0==e.button?s[0]=Math.min(s[1],l?s[1]:s[0]+1):2==e.button&&(s[0]=Math.max(0,l?0:s[0]-1),1==i.Levels[1].LevelLimit&&0==s[0]?s[0]=1:l&&(s[3]=0));var o=t.closest(".panel"),d=o.find(".panel-heading").find("span"),p=d.text().split("/").map(num),u=num(o.data("job")),c=0,f=(Math.max(r,s[0]),r<s[0]),v=get_total_sp(),g=get_max_sp();if(f)for(var b=r+1;b<=s[0];b++){var h=i.Levels[b].SkillPoint;if(p[0]+c+h>p[1]||v+c+h>g){s[0]=b-1;break}c+=h}else for(var b=r;b>s[0];b--){var h=i.Levels[b].SkillPoint;if(c-=h,!Job.Free&&!can_reduce_skill(a,i,b-1,u,Job.TSP[u]+c)){s[0]=b,c+=h;break}}if(0==s[0]&&s[3]>0&&(s[3]=0),!(s[0]+s[3]>i.MaxLevel)&&r!=s[0]){if(!Job.Free&&s[0]>r){if(!check_skill_reqs(a,i))return;if(!check_skill_groups(a,i))return}if(i.SkillGroup){var m=i.SkillGroup;Job.SkillGroups[m]||(Job.SkillGroups[m]=[]);var k=Job.SkillGroups[m];s[0]&&-1==k.indexOf(a)?k.push(a):s[0]||-1==k.indexOf(a)||(Job.SkillGroups[m]=k.filter(function(e){return e!=a}))}if(i.BaseSkillID){var _=i.BaseSkillID;Job.BaseSkills[_]||(Job.BaseSkills[_]=[]);var S=Job.BaseSkills[_];s[0]&&-1==S.indexOf(a)?S.push(a):s[0]||-1==S.indexOf(a)||(Job.BaseSkills[_]=S.filter(function(e){return e!=a}))}p[0]+=c,s[2]+=c,v+=c,Job.TSP[u]+=c;var x=t.find(".skill-bdr");this.style.backgroundImage=s[0]?n:n.replace(".png","_b.png"),s[0]&&x.removeClass("g")||x.addClass("g"),d.text(p.join("/")),t.find(".skill-lvl").removeClass("g b").text([s[0]+s[3],s[4]].join("/")).addClass(1==s[3]?"g":2==s[3]?"b":null),Job.Cache[a]=s,update_progress(),$dpop.update(this,t),history_push()}}}function level_satisfied(e,t){var a=Job.Cache[e];return a[0]>=t}function check_skill_reqs(e,t){if(t.NeedSP)for(var a=0;3>a;a++)if(Job.TSP[a]<t.NeedSP[a])return!1;if(t.ParentSkills){var l=!1;if(1==t.SkillGroup){var s=Job.SkillGroups[1];s&&-1==s.indexOf(e)&&s.length&&(l=!0)}if(!l)for(var n in t.ParentSkills)if(!level_satisfied(n,t.ParentSkills[n]))return!1}var i=Job.BaseSkills[t.BaseSkillID];return i&&-1==i.indexOf(e)&&i.length?!1:!0}function check_skill_reqs_state(e,t,a){if(t.NeedSP)for(var l=0;3>l;l++)if(Job.TSP[l]<t.NeedSP[l])return a&&a.push(format(lang.warnings.tsp,db.Lookup[t.NameID],Job.Names[l],t.NeedSP[l])),!1;if(1!=t.SkillGroup&&t.ParentSkills)for(var s in t.ParentSkills)if(!level_satisfied(s,t.ParentSkills[s]))return a&&a.push(format(lang.warnings.parent,db.Lookup[t.NameID],db.Lookup[db.Skills[s].NameID],t.ParentSkills[s])),!1;var n=Job.BaseSkills[t.BaseSkillID];return n&&-1!=n.indexOf(e)&&n.length>1?(a&&n.forEach(function(l){l!=e&&a.push(format(lang.warnings.base,db.Lookup[t.NameID],db.Lookup[db.Skills[l].NameID]))}),!1):!0}function check_skill_groups(e,t,a){var l=t.SkillGroup;if(l){var s=Job.SkillGroups[l];if(1==l&&s&&s.length)return Job.SkillGroups[1].reduce(function(l,s){if(l)return l;var n=db.Skills[s],i=!0;for(var r in n.ParentSkills)i&=level_satisfied(r,n.ParentSkills[r]);return e==s||i||a.push(format(lang.warnings.ult,db.Lookup[t.NameID],db.Lookup[n.NameID])),l|i},!1);if(s&&s.length){var n=-1!=s.indexOf(e);return a&&s.length>1&&n&&s.forEach(function(l){l!=e&&a.push(format(lang.warnings.group,db.Lookup[t.NameID],db.Lookup[db.Skills[l].NameID]))}),1==s.length&&n}}return!0}function can_reduce_skill(e,t,a,l,s){for(var n in db.Skills)if(n!=e){var i=db.Skills[n],r=Job.Cache[n];if(i.NeedSP&&r[0]&&s<i.NeedSP[l])return!1;if(1==t.SkillGroup&&1==i.SkillGroup&&r[0]>0){Job.SkillGroups[1];for(var o in i.ParentSkills)if(!level_satisfied(o,i.ParentSkills[o]))return!1}else if(i.ParentSkills&&i.ParentSkills[e]&&r[0]&&a<i.ParentSkills[e])return!1}return!0}function techniques(){var e=$("#modal"),t=$("#modal-title"),a=$("#modal-body");t.text("Techniques"),a.empty();var l=tag("div","row").append(tag("div","col-xs-2","Necklace"),tag("div","col-xs-10","stuff stuff stuff"));a.append(l),e.modal("show")}var $body=$("body"),$lang=lang.description,$d={params:function(e){return e.startsWith("{")?db.Lookup[e.substring(1,e.length-1)]:e},weapon:function(e){return db.Weapons[e]},sp:function(e,t){return e>0?tag("span",Job.TSP[t]<e?"r":null,format($lang.req.tsp,Job.Names[t],e)):null}},$dpop={persist:null,mouseenter:function(){var e=$(this),t=e.data("desc");"hover"!=t||$dpop.persist||(update_description(this,e),e.popover("show"))},mouseleave:function(){var e=$(this),t=e.data("desc");"hover"==t&&e.popover("hide")},mousedown:function(e){if(1==e.button){var t=$(this),a=t.data("desc");$dpop.update(this,t),"hover"==a?(t.data("desc","mclick"),$dpop.persist=t):(t.data("desc","hover"),$dpop.persist=null)}},update:function(e,t){$dpop.persist&&$dpop.persist.data("skill")!=t.data("skill")&&($dpop.persist.data("desc","hover").popover("hide"),$dpop.persist=null),t.popover("hide"),update_description(e,t),t.popover("show")}},desc_fields=tag("div").append(desc_tag("dlvl",$lang.fields.lvl),desc_tag("dmp",$lang.fields.mp),desc_tag("dweaps",$lang.fields.weap),desc_tag("dtype",$lang.fields.type),desc_tag("dele",$lang.fields.element),desc_tag("dcd",$lang.fields.cd),desc_tag("dlimit",$lang.fields.limit),desc_tag("dtsp",$lang.fields.tsp),tag("div","divider dreq"),tag("div","dreq o",$lang.req.lvl_up),tag("div","dreq dreqlvl").append(tag("span",null,$lang.req.char_lvl),tag("span")),tag("div","dreq dreqskills"),tag("div","dreq dreqtsp"),tag("div","dreq dreqsp").append(tag("span",null,$lang.req.sp),tag("span")),tag("div","dnow").append(tag("div","dnowf o",$lang.curr),tag("div","dnowv")),tag("div","divider dnextdiv"),tag("div","dnext").append(tag("div","dnextf o",$lang.next),tag("div","dnextv"))),ON="btn-primary",OFF="btn-default",build_chars="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_".split("");window.addEventListener("popstate",function(e){Job=e.state||$Job,dskills.each(function(){var e=$(this),t=this.getAttribute("data-skill"),a=Job.Cache[t],l=this.style.backgroundImage.replace("_b.png",".png");this.style.backgroundImage=a[0]?l:l.replace(".png","_b.png"),e.find(".skill-bdr").removeClass("g").addClass(a[0]?null:"g"),e.find(".skill-lvl").removeClass("g b").text([a[0]+a[3],a[4]].join("/")).addClass(1==a[3]?"g":2==a[3]?"b":null)});var t=get_max_sp();$(".panel").each(function(e){var a=$(this).find(".panel-heading").find("span"),l=a.text().split("/").map(num),s=Job.SP[e];l[0]=Job.TSP[e],l[1]=num(t*s),a.text(l.join("/"))}),update_progress(),$("#level").val(Job.MaxLevel);var a="#pvp",l="#pve";set_cookie("apply_type",Job.ApplyType),Job.ApplyType&&(a="#pve",l="#pvp"),$(a).removeClass(ON).addClass(OFF),$(l).addClass(ON),a="#free",l="#strict",set_cookie("free",Job.Free?1:0),Job.Free&&(a="#strict",l="#free"),$(a).removeClass(ON).addClass(OFF),$(l).addClass(ON)});